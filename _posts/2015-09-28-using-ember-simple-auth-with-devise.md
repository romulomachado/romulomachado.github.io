---
layout: post
title: Using Ember Simple Auth 1.0 with Devise
comments: true
---

## Server-side setup

These instructions assume you're using the default Devise configuration and models. As token authentication is not actually part of Devise anymore, there are some customizations necessary on the server side.

First, a new column for the authentication token must be added to the users table:

{% highlight ruby %}
class AddAuthenticationTokenToUser < ActiveRecord::Migration
  def change
    add_column :users, :authentication_token, :string
  end
end
{% endhighlight %}

That authentication token must be auto-generated by the model on creation:

{% highlight ruby %}
class User < ActiveRecord::Base
  before_save :ensure_authentication_token

  def ensure_authentication_token
    if authentication_token.blank?
      self.authentication_token = generate_authentication_token
    end
  end

  private

    def generate_authentication_token
      loop do
        token = Devise.friendly_token
        break token unless User.where(authentication_token: token).first
      end
    end
end
{% endhighlight %}

By default, Devise's sessions controller only responds to HTML request. In order for it to work with Ember Simple Auth it must also respond to JSON. To achieve that, define a custom sessions controller (_if HTML responses are not needed the format handling can be left out of course_):

{% highlight ruby %}
class SessionsController < Devise::SessionsController
  respond_to :html, :json

  def create
    super do |user|
      if request.format.json?
        data = {
          token: user.authentication_token,
          email: user.email
        }
        render json: data, status: 201 and return
      end
    end
  end
end
{% endhighlight %}

and configure Devise to use that controller instead of the default one:

{% highlight ruby %}
MyRailsApp::Application.routes.draw do
  devise_for :users, controllers: { sessions: 'sessions' }
end
{% endhighlight %}

Finally, the Rails application must authenticate users by their authentication
token and email if present:

{% highlight ruby %}
class ApplicationController < ActionController::Base
  before_filter :authenticate_user_from_token!

  # Enter the normal Devise authentication path,
  # using the token authenticated user if available
  before_filter :authenticate_user!

  private

    def authenticate_user_from_token!
      authenticate_with_http_token do |token, options|
        user_email = options[:email].presence
        user = user_email && User.find_by_email(user_email)

        if user && Devise.secure_compare(user.authentication_token, token)
          sign_in user, store: false
        end
      end
    end
end
{% endhighlight %}

The Rails application should also not issue session cookies but authentication
should be done exclusively via the authentication token as described above. The
easiest way to disable sessions in Rails is to add an initializer
`config/initializers/session_store.rb` and disable the session store in that:

{% highlight ruby %}
Rails.application.config.session_store :disabled
{% endhighlight %}

> Although `ember-simple-auth-devise` is now deprecated, this server-side guide is still valid and can be seen fully <a href="https://github.com/simplabs/ember-simple-auth/blob/master/packages/ember-simple-auth-devise/README.md" target="_blank">here</a>.

Let's use the console to create a User before moving to the Ember part.

{% highlight ruby %}
> User.create! email: "user@example.com", password: "password"
{% endhighlight %}

## The front-end side

Using [ember-cli](http://www.ember-cli.com/), let's create the app:

{% highlight bash %}
ember new frontend
{% endhighlight %}

_Make sure you're using Ember `2.0.0`._

At the time I'm writing this post, the version 1.0.0 of ember-simple-auth is not merged on `master` yet, so we'll use it from the `jj-abrams` branch.

Let's install `ember-simple-auth` by adding this line to `devDependencies` on the `package.json` file:

{% highlight javascript %}
// package.json
"ember-simple-auth": "simplabs/ember-simple-auth#jj-abrams"
{% endhighlight %}

Then run `bower install && npm install`.

This example app will have basically 3 pages: a landing page (where we'll show information about the app), a login page and a dashboard page (only logged users can see).

First, let's make the `application.js` route extend `ApplicationRouteMixin`.

> The `ApplicationRouteMixin` mixin defines actions that are triggered when authentication is required, when the session has successfully been authenticated or invalidated or when authentication or invalidation fails or authorization is rejected by the server.

{% highlight javascript %}
// app/routes/application.js
import Ember from 'ember';
import ApplicationRouteMixin from 'ember-simple-auth/mixins/application-route-mixin';

export default Ember.Route.extend(ApplicationRouteMixin);
{% endhighlight %}

Now, the landing page. Let's create a file named `index.hbs` on `app/templates/` and move the `<h2 id="title">Welcome to Ember</h2>` from `app/templates/application.hbs` to that file. Both templates should look like this:

{% highlight html %}
{% raw %}
<!-- app/templates/application.hbs -->
{{outlet}}
{% endraw %}
{% endhighlight %}

{% highlight html %}
<!-- app/templates/index.hbs -->
<h2>Welcome to Ember</h2>
{% endhighlight %}

![Welcome to Ember]({{site.url}}/public/images/blog/2015-09-28-ember-simple-auth/welcome-to-ember.png)

Now that we have a landing page, let's create the login page.

Using `ember g`, we will generate a route named `login`.

{% highlight bash %}
ember g route login
{% endhighlight %}

That will create two files (`app/routes/login.js` and `app/templates/login.hbs`), will add a route to `app/router.js` and create unit tests as well.

We now have a `/login` page we can link to. Let's add the following code to the bottom of our landing page:

{% highlight html %}
{% raw %}
{{#link-to 'login'}}Login{{/link-to}}
{% endraw %}
{% endhighlight %}

![Login link]({{site.url}}/public/images/blog/2015-09-28-ember-simple-auth/welcome-to-ember-login.png)

And add some content to `app/templates/login.hbs`:

{% highlight html %}
<!-- app/templates/login.hbs -->
<h2>Login</h2>
{% endhighlight %}

![Login page]({{site.url}}/public/images/blog/2015-09-28-ember-simple-auth/login.png)

Now, we have to create a login-form component to handle the login.

{% highlight bash %}
ember g component login-form
{% endhighlight %}

On `app/templates/components/login-form.hbs`, let's add:

{% highlight html %}
{% raw %}
<!-- app/templates/components/login-form.hbs -->
<form {{action "authenticate" on="submit"}}>
  <label for="identification">Login</label>
  {{input value=identification placeholder="Enter Login"}}

  <label for="password">Password</label>
  {{input value=password type="password" placeholder="Enter Password"}}

  <button type="submit">Login</button>
</form>

{{#if errorMessage}}
  {{errorMessage}}
{{/if}}
{% endraw %}
{% endhighlight %}

And add the `login-form` component on the login template, the `app/templates/login.hbs` file should look like this:

{% highlight html %}
{% raw %}
<!-- app/templates/login.hbs -->
<h2 id="title">Login</h2>

{{login-form}}
{% endraw %}
{% endhighlight %}

![Login form]({{site.url}}/public/images/blog/2015-09-28-ember-simple-auth/login-form.png)

The `login-form` component calls `authenticate` when the form is submitted, but there's no `authenticate` action on it yet. We need to add it:

{% highlight javascript %}
// app/components/login-form.js
import Ember from 'ember';

export default Ember.Component.extend({
  actions: {
    authenticate: function() {
      alert("Hey! I tried, but I don't know how to authenticate.");
    }
  }
});
{% endhighlight %}

![Alert]({{site.url}}/public/images/blog/2015-09-28-ember-simple-auth/alert.png)

As the component alerted, it does not know how to authenticate the session. We have to extend the `devise` authenticator `ember-simple-auth` gives us.

> **Authenticators** authenticate the session. They implement concrete mechanisms for verifying a user's identity so that an application can support multiple ways of authentication such as username and password, Facebook or github by leveraging multiple authenticators.

Create a file named `devise.js` on `app/authenticators/` and add the following code:

{% highlight javascript %}
// app/authenticators/devise.js
import Devise from 'ember-simple-auth/authenticators/devise';

export default Devise.extend({
  serverTokenEndpoint: 'http://localhost:3000/users/sign_in'
});
{% endhighlight %}

If you're running your app proxying your API server you don't need to customize the `serverTokenEndpoint` like we did, but if you're not, you have to.

Now, we have to update our `login-form` component. We need to inject ember-simple-auth's session and update our authenticate action.

> The **session** is the main interface to the library. It provides methods for authentication and invalidation of the session as well as to set and read session data. It's available as a service that can be injected wherever needed in the application.

{% highlight javascript %}
// app/components/login-form.js
import Ember from 'ember';

const { service } = Ember.inject;

export default Ember.Component.extend({
  session: service('session'),

  actions: {
    authenticate: function() {
      var data = this.getProperties('identification', 'password');
      return this.get('session').authenticate('authenticator:devise', data).catch((reason) => {
        this.set('errorMessage', reason.error);
      });
    }
  }
});
{% endhighlight %}

We also need to update the `'connect-src'` attribute on contentSecurityPolicy:

{% highlight javascript %}
// config/environment.js
contentSecurityPolicy: {
  'connect-src': "*"
}
{% endhighlight %}

Now, we need to update our `ember-simple-auth` environment configuration, on `config/environment` add:

{% highlight javascript %}
...

ENV['ember-simple-auth'] = {
  base: {
    store: 'session-store:local-storage'
  }
}

...
{% endhighlight %}

We're now telling `ember-simple-auth` to store the session on the browser's LocalStorage.

> The **session store** persists the session and all of its data so that it survives a page reload. It also synchronizes the authentication status across multiple tabs or windows so that when the user logs out in one tab or window of the application, all sensitive data is also cleared in other tabs or windows of the same application as well.

We just need to create our dashboard page, make it protected and redirect the user after login or a logged user accessing the root of the application.

Generate the route:

{% highlight bash %}
ember g route dashboard
{% endhighlight %}

We'll customize the template with a secret information and add a link to logout.

{% highlight html %}
{% raw %}
<!-- app/templates/dashboard.hbs -->
<h2>Dashboard</h2>

<p>Peter Parker is Spider-Man</p>

<a href="#" {{action 'logout'}}>Logout</a>
{% endraw %}
{% endhighlight %}

Now, we make `app/routes/dashboard.js` inherit from ember-simple-auth's `AuthenticatedRouteMixin` and add a logout action to it.

{% highlight javascript %}
import Ember from 'ember';
import AuthenticatedRouteMixin from 'ember-simple-auth/mixins/authenticated-route-mixin';

const { service } = Ember.inject;

export default Ember.Route.extend(AuthenticatedRouteMixin, {
  session: service('session'),

  actions: {
    logout() {
      this.get('session').invalidate();
    }
  }
});
{% endhighlight %}

Last but not least, we tell `ember-simple-auth` to redirect the user to dashboard if he's already authenticated and the route the user should go after the being authenticated.

{% highlight javascript %}
...

ENV['ember-simple-auth'] = {
  base: {
    store: 'session-store:local-storage',
    routeAfterAuthentication: 'dashboard',
    routeIfAlreadyAuthenticated: 'dashboard'
  }
}
...
{% endhighlight %}

And now the app is working! :sunglasses:

![App working]({{site.url}}/public/images/blog/2015-09-28-ember-simple-auth/ember-simple-auth.gif)

That wraps it up! It was a long post, but I hope you managed to make your app work. If you have something to say, hit me up on Twitter, I'm <a href="http://twitter.com/romulomachado_">@romulomachado_</a> there.

See you in the next one!
